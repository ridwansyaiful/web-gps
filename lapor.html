<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Lapor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
        .container {
            text-align: center;
            margin-top: 20px;
        }
        .button {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50; /* Warna hijau */
            color: white; /* Warna teks */
            border: none;
            border-radius: 5px;
            text-decoration: none; /* Menghilangkan garis bawah */
        }
        .button:hover {
            background-color: #45a049; /* Warna saat hover */
        }
        .blue-button {
            background-color: #008CBA; /* Warna biru */
            color: white;
        }
        .blue-button:hover {
            background-color: #007bb5; /* Warna saat hover untuk tombol biru */
        }
        .custom-size {
            padding: var(--button-padding, 10px 20px); /* Ukuran default, bisa diubah dengan CSS variable */
            font-size: var(--button-font-size, 16px); /* Ukuran font default */
        }
    </style>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/9.16.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDgPYGXqbBXt1NayhNB5M-8mjXfGKrOzWM",
            authDomain: "coba-accf3.firebaseapp.com",
            databaseURL: "https://coba-accf3-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "coba-accf3",
            storageBucket: "coba-accf3.appspot.com",
            messagingSenderId: "171764982868",
            appId: "1:171764982868:web:19c716f6617667514679c1"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let deviceID = 'device1'; // ID perangkat aktif saat ini
        let isFirstLoad = true;
        let stepSize = 0.0002; // Ukuran langkah
        let virtualLat = -7.975500; // Lokasi virtual awal
        let virtualLon = 110.333500; // Lokasi virtual awal

        let isActiveDevice = true; // Flag untuk menandakan perangkat aktif
        let virtualLocationExists = false; // Flag untuk menandakan apakah lokasi virtual sudah ada
        let userLocationVisible = false; // Flag untuk menandakan lokasi pengguna terlihat

        // Lokasi geofencing
        const defaultLocations = [
            { name: "lokasi a", coordinates: "-7.974107, 110.335574" },
            { name: "lokasi b", coordinates: "-7.974263, 110.331069" },
            { name: "lokasi c", coordinates: "-7.977164, 110.330796" },
            { name: "lokasi d", coordinates: "-7.975760, 110.334861" }
        ];

        // Lokasi default jika izin geolocation ditolak
        const fallbackLocations = [
            { name: "Fallback Lokasi 1", coordinates: "-7.975000, 110.334000" },
            { name: "Fallback Lokasi 2", coordinates: "-7.976000, 110.331500" },
            { name: "Fallback Lokasi 3", coordinates: "-7.975500, 110.333000" }
        ];

        // Ikon yang sama untuk lokasi fallback
        const iconUrl = 'https://github.com/ridwansyaiful/web-gps/raw/main/placeholder%20(1).png'; // Ganti dengan URL ikon yang valid
        const icon = L.icon({ iconUrl: iconUrl, iconSize: [25, 41] });

        function isInsideGeofence(lat, lon) {
            const bounds = defaultLocations.map(location => {
                const [lat, lon] = location.coordinates.split(',').map(coord => parseFloat(coord.trim()));
                return [lat, lon];
            });
            return L.polygon(bounds).getBounds().contains(L.latLng(lat, lon));
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius Bumi dalam kilometer
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Hasil dalam kilometer
        }

        function randomDirection() {
            const directions = [
                [stepSize, 0],    // east
                [-stepSize, 0],   // west
                [0, stepSize],    // north
                [0, -stepSize]    // south
            ];
            return directions[Math.floor(Math.random() * directions.length)];
        }

        function updateFirebaseLocation() {
            const locationRef = ref(database, `devices/virtualLocation`);
            set(locationRef, { latitude: virtualLat, longitude: virtualLon });
        }

        function simulateVirtualMovement() {
            setInterval(() => {
                if (isActiveDevice && virtualLocationExists) {
                    // Mengambil lokasi pengguna dari Firebase
                    const userLocationRef = ref(database, `devices/${deviceID}`);
                    get(userLocationRef).then(snapshot => {
                        const userLocation = snapshot.val();
                        if (!userLocation) return; // Cek jika data pengguna tidak ada

                        let userLat = userLocation.latitude;
                        let userLon = userLocation.longitude;

                        let nextLat, nextLon;

                        // Pilih arah acak untuk lokasi virtual
                        do {
                            [nextLat, nextLon] = randomDirection();
                            nextLat = virtualLat + nextLat;
                            nextLon = virtualLon + nextLon;
                        } while (
                            calculateDistance(nextLat, nextLon, userLat, userLon) < 0.02 || // Jarak aman dari pengguna
                            !isInsideGeofence(nextLat, nextLon) // Memastikan berada dalam batas geofencing
                        );

                        // Perbarui lokasi virtual
                        virtualLat = nextLat;
                        virtualLon = nextLon;

                        // Perbarui lokasi virtual ke Firebase
                        updateFirebaseLocation();

                        // Perbarui marker di peta
                        if (window.virtualMarker) {
                            map.removeLayer(window.virtualMarker);
                        }
                        window.virtualMarker = L.marker([virtualLat, virtualLon]).addTo(map);
                        window.virtualMarker.bindPopup("Titik Virtual (Simulasi)").openPopup();
                    });
                }
            }, 2000);
        }

        function initializeDevice() {
            const virtualLocationRef = ref(database, `devices/virtualLocation`);
            onValue(virtualLocationRef, (snapshot) => {
                const virtualLocation = snapshot.val();
                if (virtualLocation) {
                    virtualLat = virtualLocation.latitude;
                    virtualLon = virtualLocation.longitude;
                    virtualLocationExists = true; // Menandakan lokasi virtual ada
                    console.log("Mengikuti lokasi virtual:", virtualLat, virtualLon);
                } else {
                    // Jika tidak ada lokasi virtual, perangkat ini akan membuat lokasi virtual baru
                    virtualLocationExists = false;
                    console.log("Tidak ada lokasi virtual, perangkat ini akan membuatnya.");
                    createInitialVirtualLocation();
                }

                // Menampilkan lokasi virtual pada peta jika ada
                if (virtualLocationExists) {
                    if (window.virtualMarker) {
                        map.removeLayer(window.virtualMarker);
                    }
                    window.virtualMarker = L.marker([virtualLat, virtualLon]).addTo(map);
                    window.virtualMarker.bindPopup("Titik Virtual").openPopup();
                }
            });
        }

        function createInitialVirtualLocation() {
            const locationRef = ref(database, `devices/virtualLocation`);
            set(locationRef, { latitude: virtualLat, longitude: virtualLon }).then(() => {
                console.log("Lokasi virtual awal dibuat:", virtualLat, virtualLon);
                virtualLocationExists = true;
            }).catch((error) => {
                console.error("Gagal membuat lokasi virtual:", error);
            });
        }

        function getRandomFallbackLocation() {
            const randomIndex = Math.floor(Math.random() * fallbackLocations.length);
            return fallbackLocations[randomIndex]; // Mengambil lokasi fallback secara acak
        }

        function showFallbackLocations() {
            const location = getRandomFallbackLocation(); // Ambil lokasi fallback acak
            const [lat, lon] = location.coordinates.split(',').map(coord => parseFloat(coord.trim()));

            // Hapus marker fallback sebelumnya jika ada
            if (window.fallbackMarker) {
                map.removeLayer(window.fallbackMarker);
            }

            window.fallbackMarker = L.marker([lat, lon], { icon: icon }).addTo(map).bindPopup(location.name).openPopup();

            // Mengatur tampilan ke lokasi fallback
            map.setView([lat, lon], 15);
        }

        function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            if (isInsideGeofence(lat, lon)) {
                // Hapus lokasi fallback jika ada
                if (window.fallbackMarker) {
                    map.removeLayer(window.fallbackMarker);
                }
            }

            if (isFirstLoad) {
                // Mengatur tampilan ke lokasi pengguna pada pemuatan pertama
                map.setView([lat, lon], 15);
                isFirstLoad = false;
            }

            // Hapus marker pengguna sebelumnya jika ada
            if (window.userMarker) {
                map.removeLayer(window.userMarker);
            }

            window.userMarker = L.marker([lat, lon]).addTo(map).bindPopup("Lokasi Anda").openPopup();
            userLocationVisible = true; // Menandakan lokasi pengguna terlihat
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(showPosition, handleLocationError);
            } else {
                alert("Geolocation tidak didukung oleh browser ini.");
                showFallbackLocations(); // Tampilkan lokasi fallback jika geolocation tidak didukung
                map.setView([-7.975500, 110.333500], 15); // Set view ke lokasi default
            }
        }

        function handleLocationError(error) {
            console.error("Error mendapatkan lokasi:", error);
            userLocationVisible = false; // Menandakan lokasi pengguna tidak terlihat
            showFallbackLocations(); // Tampilkan lokasi fallback jika ada kesalahan
            map.setView([-7.975500, 110.333500], 15); // Set view ke lokasi default
        }

        // Inisialisasi peta
        const map = L.map('map').setView([-7.975500, 110.333500], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        // Buat wilayah geofencing dengan warna biru muda transparan
        const geofenceCoords = defaultLocations.map(location => {
            const [lat, lon] = location.coordinates.split(',').map(coord => parseFloat(coord.trim()));
            return [lat, lon];
        });

        L.polygon(geofenceCoords, {
            color: 'lightblue', // Warna biru muda
            fillColor: 'lightblue', // Warna pengisian
            fillOpacity: 0.5, // Transparansi
            weight: 0 // Tidak ada garis tepi
        }).addTo(map);

        // Mulai berpindah lokasi fallback setiap 3 detik
        setInterval(() => {
            if (!userLocationVisible) { // Tampilkan lokasi fallback hanya jika lokasi pengguna tidak terlihat
                showFallbackLocations();
            }
        }, 3000);

        // Memulai saat halaman dimuat
        window.onload = async () => {
            getLocation();
            initializeDevice();
            simulateVirtualMovement();
        };
    </script>
</head>
<body>
    <h1>Sistem Lapor</h1>
    <div id="map"></div>
    <div class="container">
        <h2>Pilih Salah Satu</h2>
        <a class="button" href="halaman1.html">Tombol 1</a>
        <a class="button" href="halaman2.html">Tombol 2</a>
        <a class="button" href="halaman3.html">Tombol 3</a>
        <!-- Tombol Baru dengan warna biru -->
        <a class="button blue-button custom-size" href="halaman4.html" style="--button-padding: 15px 30px; --button-font-size: 18px;">Tombol Biru</a>
    </div>
</body>
</html>
