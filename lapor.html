<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Lapor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/9.16.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDgPYGXqbBXt1NayhNB5M-8mjXfGKrOzWM",
            authDomain: "coba-accf3.firebaseapp.com",
            databaseURL: "https://coba-accf3-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "coba-accf3",
            storageBucket: "coba-accf3.appspot.com",
            messagingSenderId: "171764982868",
            appId: "1:171764982868:web:19c716f6617667514679c1"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let deviceID = 'device1'; // Ganti dengan 'device2' untuk perangkat kedua
        let isFirstLoad = true;
        let stepSize = 0.0002; // Ukuran langkah
        let virtualLat = -7.975500;
        let virtualLon = 110.333500;
        let lastDirection = null;
        let idleCounter = 0; // Counter untuk mendeteksi jika titik berhenti lama

        // Lokasi geofencing
        const defaultLocations = [
            { name: "lokasi a", coordinates: "-7.974107, 110.335574" },
            { name: "lokasi b", coordinates: "-7.974263, 110.331069" },
            { name: "lokasi c", coordinates: "-7.977164, 110.330796" },
            { name: "lokasi d", coordinates: "-7.975760, 110.334861" }
        ];

        function isInsideGeofence(lat, lon) {
            const bounds = defaultLocations.map(location => {
                const [lat, lon] = location.coordinates.split(',').map(coord => parseFloat(coord.trim()));
                return [lat, lon];
            });
            return L.polygon(bounds).getBounds().contains(L.latLng(lat, lon));
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius Bumi dalam kilometer
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Hasil dalam kilometer
        }

        function randomDirection(lastDirection) {
            const directions = [
                [stepSize, 0, 'east'],
                [-stepSize, 0, 'west'],
                [0, stepSize, 'north'],
                [0, -stepSize, 'south']
            ];

            const oppositeDirections = {
                'north': 'south',
                'south': 'north',
                'east': 'west',
                'west': 'east'
            };

            let availableDirections = directions.filter(dir => dir[2] !== oppositeDirections[lastDirection]);

            return availableDirections[Math.floor(Math.random() * availableDirections.length)];
        }

        function updateFirebaseLocation() {
            const locationRef = ref(database, `devices/${deviceID}/virtualLocation`);
            set(locationRef, { latitude: virtualLat, longitude: virtualLon });
        }

        function simulateVirtualMovement() {
            setInterval(() => {
                const userLocationRef = ref(database, `devices/${deviceID}`);
                get(userLocationRef).then(snapshot => {
                    const userLocation = snapshot.val();
                    let distanceToUser = Infinity;

                    if (userLocation) {
                        const userLat = userLocation.latitude;
                        const userLon = userLocation.longitude;
                        distanceToUser = calculateDistance(virtualLat, virtualLon, userLat, userLon);
                    }

                    let nextLat, nextLon, direction;
                    // Menghindari lokasi pengguna
                    if (distanceToUser < 0.02) {
                        do {
                            [nextLat, nextLon, direction] = randomDirection(lastDirection);
                            nextLat = virtualLat + nextLat;
                            nextLon = virtualLon + nextLon;
                        } while (calculateDistance(nextLat, nextLon, userLat, userLon) < 0.02 || !isInsideGeofence(nextLat, nextLon));
                    } else {
                        // Pilih arah acak
                        [nextLat, nextLon, direction] = randomDirection(lastDirection);
                        nextLat = virtualLat + nextLat;
                        nextLon = virtualLon + nextLon;

                        if (isInsideGeofence(nextLat, nextLon)) {
                            virtualLat = nextLat;
                            virtualLon = nextLon;
                            lastDirection = direction;
                            idleCounter = 0; // Reset counter idle saat bergerak
                        } else {
                            idleCounter++;
                        }

                        // Jika idle terlalu lama, pilih arah baru secara paksa
                        if (idleCounter >= 5) {
                            lastDirection = null;
                            idleCounter = 0;
                        }
                    }

                    // Perbarui lokasi virtual ke Firebase
                    updateFirebaseLocation(); 

                    // Perbarui marker di peta
                    if (window.virtualMarker) {
                        map.removeLayer(window.virtualMarker);
                    }
                    window.virtualMarker = L.marker([virtualLat, virtualLon]).addTo(map);
                    window.virtualMarker.bindPopup("Titik Virtual (Simulasi)").openPopup();
                });
            }, 2000);
        }

        // Inisialisasi peta
        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        const bounds = defaultLocations.map(location => {
            const [lat, lon] = location.coordinates.split(',').map(coord => parseFloat(coord.trim()));
            return [lat, lon];
        });

        L.polygon(bounds, { color: '#0000FF', weight: 0, fillOpacity: 0.05 }).addTo(map);

        function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const locationRef = ref(database, `devices/${deviceID}`);
            set(locationRef, { latitude: lat, longitude: lon, timestamp: Date.now() });

            if (isFirstLoad) {
                map.setView([lat, lon], 15);
                isFirstLoad = false;
            }

            if (window.userMarker) {
                map.removeLayer(window.userMarker);
            }

            window.userMarker = L.marker([lat, lon]).addTo(map).bindPopup("Lokasi Anda").openPopup();
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(showPosition);
            } else {
                alert("Geolocation tidak didukung oleh browser ini.");
            }
        }

        // Mendengarkan perubahan lokasi virtual dari Firebase untuk perangkat lain
        function listenForVirtualLocations() {
            const otherDeviceID = 'device2'; // ID perangkat lain yang akan dipantau
            const virtualLocationRef = ref(database, `devices/${otherDeviceID}/virtualLocation`);
            onValue(virtualLocationRef, (snapshot) => {
                const virtualLocation = snapshot.val();
                if (virtualLocation) {
                    const { latitude, longitude } = virtualLocation;
                    if (window.otherDeviceMarker) {
                        map.removeLayer(window.otherDeviceMarker);
                    }
                    window.otherDeviceMarker = L.marker([latitude, longitude]).addTo(map);
                    window.otherDeviceMarker.bindPopup("Titik Virtual Perangkat 2").openPopup();
                }
            });
        }

        window.onload = () => {
            getLocation();
            listenForVirtualLocations();
            simulateVirtualMovement();
        };
    </script>
</head>
<body>
    <h1>Sistem Lapor</h1>
    <div id="map"></div>
</body>
</html>
