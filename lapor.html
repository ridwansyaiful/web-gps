<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Lapor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        /* Atur tinggi peta */
        #map {
            height: 400px; /* Atur tinggi peta */
            width: 100%; /* Lebar penuh */
        }
    </style>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js';
        import { getDatabase, ref, set, remove, onValue, get } from 'https://www.gstatic.com/firebasejs/9.16.0/firebase-database.js';

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyDgPYGXqbBXt1NayhNB5M-8mjXfGKrOzWM",
            authDomain: "coba-accf3.firebaseapp.com",
            databaseURL: "https://coba-accf3-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "coba-accf3",
            storageBucket: "coba-accf3.appspot.com",
            messagingSenderId: "171764982868",
            appId: "1:171764982868:web:19c716f6617667514679c1"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let deviceID = 'device1'; // Nama perangkat awal
        let isFirstLoad = true; // Flag untuk menandakan apakah peta baru pertama kali dimuat

        // Fungsi untuk mendapatkan lokasi
        function getLocation() {
            console.log("Meminta lokasi...");
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(showPosition, showError, {
                    enableHighAccuracy: true
                });
            } else {
                alert("Geolocation tidak didukung oleh browser ini.");
            }
        }

        function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Kondisi: Jika pengguna memberikan izin lokasi
            if (position.coords.accuracy) {
                // Kirim lokasi ke Firebase
                const locationRef = ref(database, `devices/${deviceID}`);
                set(locationRef, {
                    latitude: lat,
                    longitude: lon,
                    timestamp: Date.now()
                });

                // Tampilkan lokasi di peta dengan ikon hijau
                updateMap(lat, lon, true); // true untuk ikon hijau
                
                // Hapus pesan penolakan izin (jika ada)
                const notificationRef = ref(database, `notifications/${deviceID}`);
                remove(notificationRef);
            }
        }

        function showError(error) {
            const notificationRef = ref(database, `notifications/${deviceID}`);
            console.log("Error mendapatkan lokasi:", error); // Log kesalahan untuk debug

            // Jika izin lokasi ditolak, tampilkan pesan
            if (error.code === error.PERMISSION_DENIED) {
                // Tampilkan lokasi lokal pada device sendiri (tidak dikirim ke Firebase)
                useLocalLocation();
                set(notificationRef, {
                    message: "Target tidak izinkan lokasi"
                });
            } else {
                alert("Gagal mendapatkan lokasi.");
            }
        }

        // Fungsi untuk menggunakan lokasi lokal (tidak dikirim ke Firebase)
        function useLocalLocation() {
            const defaultLocalLat = -7.975000; // Lokasi lat lokal default
            const defaultLocalLon = 110.334000; // Lokasi lon lokal default

            // Tampilkan lokasi lokal di peta dengan ikon merah
            updateMap(defaultLocalLat, defaultLocalLon, false); // false untuk ikon merah
        }

        // Fungsi untuk mencari ID perangkat unik yang tersedia
        async function findAvailableDeviceID() {
            let i = 1;
            let found = false;
            while (!found) {
                const deviceRef = ref(database, `devices/device${i}`);
                const snapshot = await get(deviceRef);
                if (!snapshot.exists()) {
                    deviceID = `device${i}`;
                    found = true;
                }
                i++;
            }
            console.log("ID Perangkat yang dipakai:", deviceID);
        }

        // Lokasi default yang akan digunakan untuk geofencing (empat sudut area)
        const defaultLocations = [
            { name: "lokasi a", coordinates: "-7.974107, 110.335574" }, // Lokasi A (sudut 1)
            { name: "lokasi b", coordinates: "-7.974263, 110.331069" }, // Lokasi B (sudut 2)
            { name: "lokasi c", coordinates: "-7.977164, 110.330796" }, // Lokasi C (sudut 3)
            { name: "lokasi d", coordinates: "-7.975760, 110.334861" }  // Lokasi D (sudut 4)
        ];

        // Lokasi tambahan di dalam area geofencing (untuk ikon rumah)
        const additionalLocations = [
            { name: "Rumah 1", coordinates: "-7.975000, 110.334000" },
            { name: "Rumah 2", coordinates: "-7.976000, 110.331500" },
            { name: "Rumah 3", coordinates: "-7.975500, 110.333000" },
            { name: "Rumah 4", coordinates: "-7.976500, 110.335000" }
        ];

        // Inisialisasi peta
        const map = L.map('map'); 

        // Menambahkan layer peta dari OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        // Menghitung bounding box (geofencing) dari empat sudut lokasi
        const bounds = defaultLocations.map(location => {
            const [lat, lon] = location.coordinates.split(',').map(coord => parseFloat(coord.trim()));
            return [lat, lon];
        });

        // Menambahkan area geofencing tanpa marker dan garis, serta dengan transparansi lebih tinggi
        L.polygon(bounds, { 
            color: '#0000FF', // Warna biru muda
            weight: 0, // Menghapus garis luar
            fillOpacity: 0.05 // Transparansi lebih tinggi
        }).addTo(map);

        // Menambahkan ikon rumah ke lokasi tambahan
        const houseIcon = L.icon({
            iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/5/5c/House_icon.svg', // Ganti dengan URL ikon rumah yang lebih umum
            iconSize: [30, 30], // Ukuran ikon
            iconAnchor: [15, 30], // Titik yang menunjukkan posisi ikon
            popupAnchor: [0, -30] // Titik yang menunjukkan posisi popup
        });

        additionalLocations.forEach(location => {
            const [lat, lon] = location.coordinates.split(',').map(coord => parseFloat(coord.trim()));
            L.marker([lat, lon], { icon: houseIcon })
                .addTo(map)
                .bindPopup(location.name);
        });

        // Fungsi untuk menampilkan lokasi dari Firebase (lokasi pengguna)
        function updateMap(lat, lon, isAuthorized) {
            // Menghapus marker lama jika ada
            if (window.userMarker) {
                map.removeLayer(window.userMarker);
            }

            // Menentukan ikon berdasarkan apakah lokasi diizinkan atau tidak
            const userIcon = L.icon({
                iconUrl: isAuthorized
                    ? 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4a/Simpleicons_Interface_check-mark-green.svg/1024px-Simpleicons_Interface_check-mark-green.svg.png' // Ikon hijau
                    : 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/34/Red_x.svg/1024px-Red_x.svg.png', // Ikon merah
                iconSize: [30, 30], // Ukuran ikon
                iconAnchor: [15, 30], // Titik yang menunjukkan posisi ikon
                popupAnchor: [0, -30] // Titik yang menunjukkan posisi popup
            });

            // Tambahkan marker pengguna ke peta
            window.userMarker = L.marker([lat, lon], { icon: userIcon }).addTo(map);
            
            // Set zoom dan view hanya pada pertama kali memuat peta
            if (isFirstLoad) {
                const zoomLevel = 15; // Anda bisa mengatur zoom level ini sesuai kebutuhan
                map.setView([lat, lon], zoomLevel);
                isFirstLoad = false; // Set flag ke false setelah peta pertama kali dimuat
            }
        }

        // Cari deviceID yang tersedia dan jalankan fungsi untuk mendapatkan lokasi
        findAvailableDeviceID().then(() => getLocation());
    </script>
</head>
<body>
    <h1>Sistem Lapor</h1>
    <div id="map"></div>
    <!-- Elemen peta akan ditampilkan di sini -->
</body>
</html>
